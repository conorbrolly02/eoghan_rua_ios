name: iOS Build & Sign (BeeWare Briefcase)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    env:
      # MUST match app.py app_id and pyproject (bundle + "." + app_name)
      BUNDLE_ID: ie.eoghanrua.eoghanruateamselector
      BRIEFCASE_VERBOSE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ðŸ”¥ Clean BEFORE any Briefcase step (prevents stale Xcode/metadata)
      - name: Clean build artifacts
        shell: bash
        run: |
          set -euo pipefail
          rm -rf build
          rm -rf dist

      - name: Install Briefcase + Pillow
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install briefcase Pillow

      # Fail fast if the app slug/sources/app_name are not exactly as required
      - name: Validate Briefcase slug & sources (fail fast)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import sys, tomllib, pathlib
          py = pathlib.Path("pyproject.toml").read_bytes()
          data = tomllib.loads(py.decode("utf-8"))
          apps = data.get("tool", {}).get("briefcase", {}).get("app", {})
          if not apps or len(apps) != 1:
              print(f"::error::Expected exactly 1 [tool.briefcase.app.*] section; found {len(apps)}.")
              sys.exit(1)
          slug = list(apps.keys())[0]
          sources = data.get("tool", {}).get("briefcase", {}).get("sources", [])
          print(f"Detected slug: {slug}")
          print(f"Detected sources: {sources}")
          if "eoghan_rua_team_selector" not in sources:
              print("::error::sources must include 'eoghan_rua_team_selector'")
              sys.exit(1)
          if slug != "eoghan_rua_team_selector":
              print(f"::error::app slug must be 'eoghan_rua_team_selector' (was '{slug}')")
              sys.exit(1)
          app = apps[slug]
          app_name = app.get("app_name")
          if app_name != "eoghanruateamselector":
              print(f"::error::app_name must be 'eoghanruateamselector' (was '{app_name}')")
              sys.exit(1)
          print("Briefcase configuration looks good.")
          PY

      # Optional: quick import check so we know the package is importable
      - name: Sanity import the package
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import importlib
          import eoghan_rua_team_selector as pkg
          print("OK: imported", pkg.__name__)
          PY

      - name: Generate iOS AppIcon variants from base image
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p assets
          if [ ! -f assets/icon.png ]; then
            if [ -f assets/crest.png ]; then
              cp assets/crest.png assets/icon.png
              echo "No assets/icon.png found; copied assets/crest.png -> assets/icon.png"
            else
              echo "::warning::No assets/icon.png or assets/crest.png found; icon variants won't be rendered."
            fi
          fi
          python - <<'PY'
          import os
          from PIL import Image
          base = "assets/icon.png"
          sizes = [20,29,40,58,60,76,80,87,120,152,167,180,640,1024,1280,1920]
          if os.path.exists(base):
              img = Image.open(base).convert("RGBA")
              try:
                  RES = Image.Resampling.LANCZOS
              except Exception:
                  RES = Image.LANCZOS
              for s in sizes:
                  out = f"assets/icon.png-{s}.png"
                  img.resize((s, s), RES).save(out)
                  print("Wrote", out)
          else:
              print("Base icon not found; skipping variant rendering")
          PY

      - name: Create iOS project & update metadata/resources
        shell: bash
        run: |
          set -euo pipefail
          PLATFORM="iOS"
          if briefcase update "iOS" -h >/dev/null 2>&1; then
            PLATFORM="iOS"
          elif briefcase update "iOS Xcode" -h >/dev/null 2>&1; then
            PLATFORM="iOS Xcode"
          fi
          echo "Detected Briefcase platform target: $PLATFORM"
          briefcase create "$PLATFORM" || true
          set +e
          briefcase update "$PLATFORM" -r --update-resources
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "Combined update failed (RC=$RC); trying separate refreshes..."
            briefcase update "$PLATFORM" -r || true
            briefcase update "$PLATFORM" --update-resources || true
          fi
          set -e

      - name: Build iOS App
        shell: bash
        run: |
          set -euo pipefail
          if briefcase build "iOS" -h >/dev/null 2>&1; then
            briefcase build "iOS"
          else
            briefcase build "iOS Xcode"
          fi

      - name: Locate Xcode directory
        id: xcode
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR=$(find build -type d -name "xcode" | head -n 1)
          if [ -z "$APP_DIR" ]; then
            echo "ERROR: Xcode directory not found under build/"
            exit 1
          fi
          echo "APP_DIR=$APP_DIR" >> $GITHUB_OUTPUT
          echo "Found Xcode dir: $APP_DIR"

      - name: Determine scheme
        id: scheme
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH=$(find "${{ steps.xcode.outputs.APP_DIR }}" -type d -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found to infer scheme"
            exit 1
          fi
          SCHEME=$(basename "$APP_PATH" .app)
          echo "SCHEME=$SCHEME" >> $GITHUB_OUTPUT
          echo "Using scheme: $SCHEME"

      # Decode & verify P12 BEFORE import (saves time if password/secret is wrong)
      - name: Decode & verify PKCS#12
        env:
          IOS_CERT_BASE64: ${{ secrets.IOS_CERT_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
        shell: bash
        run: |
          set -euo pipefail
          CERT_P12="$RUNNER_TEMP/cert.p12"
          echo "$IOS_CERT_BASE64" | base64 --decode > "$CERT_P12"
          openssl pkcs12 -in "$CERT_P12" -passin pass:"$IOS_CERT_PASSWORD" -info -nokeys -noout

      - name: Set up signing (import cert + profile) and validate profile AppID
        id: signing
        env:
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          BUNDLE_ID: ${{ env.BUNDLE_ID }}
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN="$RUNNER_TEMP/ios-signing.keychain-db"
          KEYCHAIN_PWD="$(uuidgen)"
          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security set-keychain-settings -lut 3600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security list-keychains -d user -s "$KEYCHAIN"
          security import "$RUNNER_TEMP/cert.p12" -k "$KEYCHAIN" -P "$IOS_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PWD" "$KEYCHAIN"
          security find-identity -v -p codesigning "$KEYCHAIN" || true

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/profile.mobileprovision"
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"
          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          /usr/bin/security cms -D -i "$PROFILE_PATH" > "$PROFILE_PLIST"

          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$PROFILE_PLIST")
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$PROFILE_PLIST")
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' "$PROFILE_PLIST")
          APPID_FULL=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' "$PROFILE_PLIST" || true)

          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_OUTPUT
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_OUTPUT
          echo "TEAM_ID=$TEAM_ID" >> $GITHUB_OUTPUT
          echo "KEYCHAIN=$KEYCHAIN" >> $GITHUB_OUTPUT
          echo "Profile application-identifier: $APPID_FULL"

          if [ -n "$APPID_FULL" ]; then
            APPID_NO_TEAM="${APPID_FULL#*.}"
            if [ "$APPID_NO_TEAM" != "$BUNDLE_ID" ]; then
              echo "::error::Provisioning profile AppID ($APPID_NO_TEAM) does not match BUNDLE_ID ($BUNDLE_ID)"
              exit 1
            fi
          else
            echo "::warning::No application-identifier found in profile entitlements; skipping check."
          fi

      - name: Archive iOS app
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.xcode.outputs.APP_DIR }}"
          xcodebuild \
            -scheme "${{ steps.scheme.outputs.SCHEME }}" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            DEVELOPMENT_TEAM="${{ steps.signing.outputs.TEAM_ID }}" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="${{ steps.signing.outputs.PROFILE_NAME }}" \
            PROVISIONING_PROFILE="${{ steps.signing.outputs.PROFILE_UUID }}" \
            OTHER_CODE_SIGN_FLAGS="--keychain ${{ steps.signing.outputs.KEYCHAIN }}" \
            -archivePath EoghanRua.xcarchive \
            archive

      - name: Finalize signing order (frameworks â†’ embed profile â†’ app)
        shell: bash
        run: |
          set -euo pipefail
          APP="${{ steps.xcode.outputs.APP_DIR }}/EoghanRua.xcarchive/Products/Applications/${{ steps.scheme.outputs.SCHEME }}.app"
          KEYCHAIN="${{ steps.signing.outputs.KEYCHAIN }}"
          IDENTITY_HASH=$(security find-identity -v -p codesigning "$KEYCHAIN" | awk '/Apple Distribution/ {print $2; exit}')
          if [ -z "$IDENTITY_HASH" ]; then
            echo "ERROR: Apple Distribution identity not found"
            exit 1
          fi
          ENT_APP="$RUNNER_TEMP/app_ents.plist"
          codesign -d --entitlements :- "$APP" > "$ENT_APP" 2>/dev/null || true
          find "$APP/Frameworks" -maxdepth 1 -type d -name "*.framework" 2>/dev/null | while read -r FW; do
            echo " sign $FW"
            codesign --force --keychain "$KEYCHAIN" --sign "$IDENTITY_HASH" "$FW"
          done
          while IFS= read -r F; do
            if file "$F" | grep -q "Mach-O"; then
              echo " sign $F"
              codesign --force --keychain "$KEYCHAIN" --sign "$F"
            fi
          done < <(find "$APP" -type f \( -name "*.dylib" -o -name "*.so" -o -perm -111 \) 2>/dev/null)
          cp "$HOME/Library/MobileDevice/Provisioning Profiles/profile.mobileprovision" "$APP/embedded.mobileprovision"
          codesign --force --keychain "$KEYCHAIN" --sign "$IDENTITY_HASH" --entitlements "$ENT_APP" "$APP"

      - name: Verify code signatures (archive) & crest resource
        shell: bash
        run: |
          set -euo pipefail
          APP="${{ steps.xcode.outputs.APP_DIR }}/EoghanRua.xcarchive/Products/Applications/${{ steps.scheme.outputs.SCHEME }}.app"
          codesign -vvv --deep --strict "$APP"
          if [ -f "$APP/resources/crest.png" ]; then
            echo "OK: crest.png found under resources/"
          else
            echo "::warning::crest.png not found under resources/ (check pyproject resources= and code path)"
          fi

      - name: Package IPA manually
        id: manualipa
        shell: bash
        run: |
          set -euo pipefail
          APP_ROOT="${{ steps.xcode.outputs.APP_DIR }}/EoghanRua.xcarchive/Products/Applications"
          OUT="${{ steps.xcode.outputs.APP_DIR }}/manual_export"
          mkdir -p "$OUT/Payload"
          cp -R "$APP_ROOT/${{ steps.scheme.outputs.SCHEME }}.app" "$OUT/Payload/"
          (cd "$OUT" && zip -qry "EoghanRua-AdHoc-Manual.ipa" Payload)
          echo "IPA_PATH=$OUT/EoghanRua-AdHoc-Manual.ipa" >> $GITHUB_OUTPUT
          ls -lh "$OUT"

      - name: Verify IPA content signatures
        shell: bash
        run: |
          set -euo pipefail
          TMPDIR=$(mktemp -d)
          cp "${{ steps.manualipa.outputs.IPA_PATH }}" "$TMPDIR/app.ipa"
          cd "$TMPDIR"
          unzip -q app.ipa
          APP="Payload/${{ steps.scheme.outputs.SCHEME }}.app"
          codesign -vvv --deep --strict "$APP"
          if [ -f "$APP/resources/crest.png" ]; then
            echo "OK: crest.png present inside IPA resources/"
          else
            echo "::warning::crest.png missing inside IPA resources/"
          fi

      - name: Upload IPA (Manual)
        uses: actions/upload-artifact@v4
        with:
          name: EoghanRua-AdHoc-IPA-Manual
          path: ${{ steps.manualipa.outputs.IPA_PATH }}
