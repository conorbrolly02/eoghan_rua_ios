name: iOS Build & Sign (BeeWare Briefcase)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    env:
      # MUST match app.py app_id and pyproject (bundle + "." + app_name)
      BUNDLE_ID: ie.eoghanrua.eoghanruateamselector
      BRIEFCASE_VERBOSE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ðŸ”¥ Clean BEFORE any Briefcase step (prevents stale Xcode/metadata)
      - name: Clean build artifacts
        shell: bash
        run: |
          set -euo pipefail
          rm -rf build
          rm -rf dist

      - name: Install Briefcase + Pillow
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install briefcase Pillow

      # Print the exact app sections and sources as seen by the runner
      - name: Print pyproject app sections & sources
        shell: bash
        run: |
          set -euo pipefail
          echo "---- [tool.briefcase.app.*] sections ----"
          grep -n '^\[tool\.briefcase\.app\.' pyproject.toml || true
          echo "---- sources line(s) ----"
          grep -n '^[[:space:]]*sources[[:space:]]*=' pyproject.toml || true

      # Validate AND autoâ€‘patch if needed so we never hit the same error again
      - name: Validate & autoâ€‘patch pyproject slug/sources/app_name
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import sys, re, pathlib, tomllib
          p = pathlib.Path("pyproject.toml")
          txt = p.read_text(encoding="utf-8")
          # Autoâ€‘patch any wrong slug header to the correct one
          corrected = re.sub(
              r"\[tool\.briefcase\.app\.eoghanruateamselector\]",
              "[tool.briefcase.app.eoghan_rua_team_selector]",
              txt,
              flags=re.IGNORECASE,
          )
          if corrected != txt:
              print("Patched app slug in pyproject.toml -> eoghan_rua_team_selector")
              p.write_text(corrected, encoding="utf-8")

          data = tomllib.loads(p.read_text(encoding="utf-8"))
          apps = data.get("tool", {}).get("briefcase", {}).get("app", {})
          if not apps or len(apps) != 1:
              print(f"::error::Expected exactly 1 [tool.briefcase.app.*] section; found {len(apps)}: {list(apps.keys())}")
              sys.exit(1)

          slug = list(apps.keys())[0]
          sources = data.get("tool", {}).get("briefcase", {}).get("sources", [])
          print(f"Slug detected: {slug}")
          print(f"Sources detected: {sources}")
          if "eoghan_rua_team_selector" not in sources:
              print("::error::sources must include 'eoghan_rua_team_selector'")
              sys.exit(1)
          if slug != "eoghan_rua_team_selector":
              print(f"::error::app slug must be 'eoghan_rua_team_selector' (was '{slug}')")
              sys.exit(1)

          app = apps[slug]
          app_name = app.get("app_name")
          if app_name != "eoghanruateamselector":
              print(f"::error::app_name must be 'eoghanruateamselector' (was '{app_name}')")
              sys.exit(1)
          print("Briefcase configuration looks good.")
          PY

      # Optional: package import sanity check (ensures package exists on disk)
      - name: Sanity import the package
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import importlib
          import eoghan_rua_team_selector as pkg
          print("OK: imported", pkg.__name__)
          PY

      - name: Generate iOS AppIcon variants from base image
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p assets
          if [ ! -f assets/icon.png ]; then
            if [ -f assets/crest.png ]; then
              cp assets/crest.png assets/icon.png
              echo "No assets/icon.png found; copied assets/crest.png -> assets/icon.png"
            else
              echo "::warning::No assets/icon.png or assets/crest.png found; icon variants won't be rendered."
            fi
          fi
          python - <<'PY'
          import os
          from PIL import Image
          base = "assets/icon.png"
          sizes = [20,29,40,58,60,76,80,87,120,152,167,180,640,1024,1280,1920]
          if os.path.exists(base):
              img = Image.open(base).convert("RGBA")
              try:
                  RES = Image.Resampling.LANCZOS
              except Exception:
                  RES = Image.LANCZOS
              for s in sizes:
                  out = f"assets/icon.png-{s}.png"
                  img.resize((s, s), RES).save(out)
                  print("Wrote", out)
          else:
              print("Base icon not found; skipping variant rendering")
          PY

      - name: Create iOS project & update metadata/resources
        shell: bash
        run: |
          set -euo pipefail
          PLATFORM="iOS"
          if briefcase update "iOS" -h >/dev/null 2>&1; then
            PLATFORM="iOS"
          elif briefcase update "iOS Xcode" -h >/dev/null 2>&1; then
            PLATFORM="iOS Xcode"
          fi
          echo "Detected Briefcase platform target: $PLATFORM"
          briefcase create "$PLATFORM" || true
          set +e
          briefcase update "$PLATFORM" -r --update-resources
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "Combined update failed (RC=$RC); trying separate refreshes..."
            briefcase update "$PLATFORM" -r || true
            briefcase update "$PLATFORM" --update-resources || true
          fi
          set -e

      - name: Build iOS App
        shell: bash
        run: |
          set -euo pipefail
          if briefcase build "iOS" -h >/dev/null 2>&1; then
            briefcase build "iOS"
          else
            briefcase build "iOS Xcode"
          fi

      - name: Locate Xcode directory
        id: xcode
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR=$(find build -type d -name "xcode" | head -n 1)
          if [ -z "$APP_DIR" ]; then
            echo "ERROR: Xcode directory not found under build/"
            exit 1
          fi
          echo "APP_DIR=$APP_DIR" >> $GITHUB_OUTPUT
          echo "Found Xcode dir: $APP_DIR"

      - name: Determine scheme
        id: scheme
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH=$(find "${{ steps.xcode.outputs.APP_DIR }}" -type d -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found to infer scheme"
            exit 1
          fi
          SCHEME=$(basename "$APP_PATH" .app)
          echo "SCHEME=$SCHEME" >> $GITHUB_OUTPUT
          echo "Using scheme: $SCHEME"

      # Decode & verify P12 BEFORE import (saves time if password/secret is wrong)
      - name: Decode & verify PKCS#12
        env:
          IOS_CERT_BASE64: ${{ secrets.IOS_CERT_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
        shell: bash
        run: |
          set -euo pipefail
          CERT_P12="$RUNNER_TEMP/cert.p12"
          echo "$IOS_CERT_BASE64" | base64 --decode > "$CERT_P12"
          openssl pkcs12 -in "$CERT_P12" -passin pass:"$IOS_CERT_PASSWORD" -info -nokeys -noout

      # (â€¦ keep your signing/archive/package steps unchanged below â€¦)
      # -- snip --
