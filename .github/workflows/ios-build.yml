
name: iOS Build & Sign (BeeWare Briefcase)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    env:
      BUNDLE_ID: ie.eoghanrua.eoghan-rua-team-selector

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Python + Briefcase
      # ------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Briefcase
        run: |
          python -m pip install --upgrade pip
          pip install briefcase

      # ------------------------------------------------------------
      # Build iOS project with Briefcase
      # ------------------------------------------------------------
      - name: Create iOS Project
        run: briefcase create iOS

      - name: Build iOS App
        run: briefcase build iOS

      # ------------------------------------------------------------
      # Locate Xcode project directory
      # ------------------------------------------------------------
      - name: Locate Xcode directory
        id: xcode
        run: |
          APP_DIR=$(find build -type d -name "xcode" | head -n 1)
          if [ -z "$APP_DIR" ]; then
            echo "ERROR: Xcode directory not found under build/"
            exit 1
          fi
          echo "APP_DIR=$APP_DIR" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Determine scheme from .app name
      # ------------------------------------------------------------
      - name: Determine scheme
        id: scheme
        run: |
          APP_PATH=$(find "${{ steps.xcode.outputs.APP_DIR }}" -type d -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found to infer scheme"
            exit 1
          fi
          SCHEME=$(basename "$APP_PATH" .app)
          echo "Using scheme: $SCHEME"
          echo "SCHEME=$SCHEME" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Install signing certificate + provisioning profile
      # ------------------------------------------------------------
      - name: Set up signing
        id: signing
        env:
          IOS_CERT_BASE64: ${{ secrets.IOS_CERT_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          set -e

          KEYCHAIN="$RUNNER_TEMP/ios-signing.keychain-db"
          KEYCHAIN_PWD="$(uuidgen)"

          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security set-keychain-settings -lut 3600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security list-keychains -d user -s "$KEYCHAIN"

          echo "$IOS_CERT_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN" \
            -P "$IOS_CERT_PASSWORD" \
            -T /usr/bin/codesign

          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PWD" "$KEYCHAIN"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/profile.mobileprovision"
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"

          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE_PATH" > "$PROFILE_PLIST"

          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$PROFILE_PLIST")
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' "$PROFILE_PLIST")

          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_OUTPUT
          echo "TEAM_ID=$TEAM_ID" >> $GITHUB_OUTPUT
          echo "KEYCHAIN=$KEYCHAIN" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Archive app (signed)
      # ------------------------------------------------------------
      - name: Archive iOS app
        run: |
          cd "${{ steps.xcode.outputs.APP_DIR }}"

          xcodebuild \
            -scheme "${{ steps.scheme.outputs.SCHEME }}" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            DEVELOPMENT_TEAM="${{ steps.signing.outputs.TEAM_ID }}" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="${{ steps.signing.outputs.PROFILE_NAME }}" \
            OTHER_CODE_SIGN_FLAGS="--keychain ${{ steps.signing.outputs.KEYCHAIN }}" \
            -archivePath EoghanRua.xcarchive \
            archive

      # ------------------------------------------------------------
      # Export IPA
      # ------------------------------------------------------------
      - name: Export signed IPA
        run: |
          cd "${{ steps.xcode.outputs.APP_DIR }}"

          cat > ExportOptions.plist <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
 "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>method</key>
    <string>ad-hoc</string>
    <key>signingStyle</key>
    <string>manual</string>
    <key>teamID</key>
    <string>${{ steps.signing.outputs.TEAM_ID }}</string>
    <key>provisioningProfiles</key>
    <dict>
      <key>${{ env.BUNDLE_ID }}</key>
      <string>${{ steps.signing.outputs.PROFILE_NAME }}</string>
    </dict>
  </dict>
</plist>
EOF

          xcodebuild -exportArchive \
            -archivePath EoghanRua.xcarchive \
            -exportPath export \
            -exportOptionsPlist ExportOptions.plist

      # ------------------------------------------------------------
      # Upload IPA artifact
      # ------------------------------------------------------------
      - name: Upload signed IPA
        uses: actions/upload-artifact@v4
        with:
          name: EoghanRua-AdHoc-IPA
          path: ${{ steps.xcode.outputs.APP_DIR }}/export/*.ipa
