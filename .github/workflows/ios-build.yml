name: iOS Build & Sign (BeeWare Briefcase)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    env:
      BUNDLE_ID: ie.eoghanrua.eoghanruateamselector
      BRIEFCASE_VERBOSE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ðŸ”¥ Clean BEFORE any Briefcase step (prevents stale Xcode/metadata)
      - name: Clean build artifacts
        shell: bash
        run: |
          set -euo pipefail
          rm -rf build
          rm -rf dist

      - name: Install Briefcase + Pillow
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install briefcase Pillow

      # Normalize pyproject.toml to avoid smart quotes/CRLF/BOM issues
      - name: Normalize pyproject.toml formatting
        shell: bash
        run: |
          set -euo pipefail
          # Convert CRLF to LF
          perl -i -pe 's/\r\n/\n/g' pyproject.toml
          # Replace curly quotes and em/en-dashes with ASCII
          python - <<'PY'
          from pathlib import Path
          s = Path('pyproject.toml').read_text(encoding='utf-8', errors='replace')
          s = (s.replace('â€œ','"').replace('â€','"')
                 .replace('â€™',"'").replace('â€˜',"'")
                 .replace('â€“','-').replace('â€”','-'))
          Path('pyproject.toml').write_text(s, encoding='utf-8')
          PY

      # Show what the runner actually sees (lines + bytes)
      - name: Show pyproject first 40 lines and bytes
        shell: bash
        run: |
          set -euo pipefail
          echo "----- pyproject (first 40 lines) -----"
          nl -ba pyproject.toml | sed -n '1,40p'
          echo "----- pyproject (first 256 bytes, hex) -----"
          xxd -g1 -l 256 pyproject.toml || true

      # Validate & auto-patch slug/sources/app_name (fail fast if wrong)
      - name: Validate & autoâ€‘patch pyproject slug/sources/app_name
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import sys, re, pathlib, tomllib
          p = pathlib.Path("pyproject.toml")
          txt = p.read_text(encoding="utf-8")
          # Autoâ€‘patch a wrong slug header if present
          patched = re.sub(
              r"\[tool\.briefcase\.app\.eoghanruateamselector\]",
              "[tool.briefcase.app.eoghan_rua_team_selector]",
              txt, flags=re.IGNORECASE,
          )
          if patched != txt:
              print("Patched app slug in pyproject.toml -> eoghan_rua_team_selector")
              p.write_text(patched, encoding="utf-8")

          data = tomllib.loads(p.read_text(encoding="utf-8"))
          apps = data.get("tool", {}).get("briefcase", {}).get("app", {})
          if not apps or len(apps) != 1:
              print(f"::error::Expected exactly 1 [tool.briefcase.app.*] section; found {len(apps)}: {list(apps.keys())}")
              sys.exit(1)
          slug = list(apps.keys())[0]
          sources = data.get("tool", {}).get("briefcase", {}).get("sources", [])
          print(f"Slug detected: {slug}")
          print(f"Sources detected: {sources}")
          if "eoghan_rua_team_selector" not in sources:
              print("::error::sources must include 'eoghan_rua_team_selector'")
              sys.exit(1)
          if slug != "eoghan_rua_team_selector":
              print(f"::error::app slug must be 'eoghan_rua_team_selector' (was '{slug}')")
              sys.exit(1)
          app = apps[slug]
          app_name = app.get("app_name")
          if app_name != "eoghanruateamselector":
              print(f"::error::app_name must be 'eoghanruateamselector' (was '{app_name}')")
              sys.exit(1)
          print("Briefcase configuration looks good.")
          PY

      # Optional: ensure Python can import your package (proves __init__.py is correct)
      - name: Sanity import the package
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import eoghan_rua_team_selector as pkg
          print("OK: imported", pkg.__name__)
          PY

      # Create/update/build with Briefcase
      - name: Create iOS project & update metadata/resources
        shell: bash
        run: |
          set -euo pipefail
          PLATFORM="iOS"
          if briefcase update "iOS" -h >/dev/null 2>&1; then
            PLATFORM="iOS"
          elif briefcase update "iOS Xcode" -h >/dev/null 2>&1; then
            PLATFORM="iOS Xcode"
          fi
          echo "Detected Briefcase platform target: $PLATFORM"
          briefcase create "$PLATFORM" || true
          set +e
          briefcase update "$PLATFORM" -r --update-resources
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "Combined update failed (RC=$RC); trying separate refreshes..."
            briefcase update "$PLATFORM" -r || true
            briefcase update "$PLATFORM" --update-resources || true
          fi
          set -e

      - name: Build iOS App
        shell: bash
        run: |
          set -euo pipefail
          if briefcase build "iOS" -h >/dev/null 2>&1; then
            briefcase build "iOS"
          else
            briefcase build "iOS Xcode"
          fi

      # (â€¦ keep your signing/archive/package steps as in the last working version â€¦)
